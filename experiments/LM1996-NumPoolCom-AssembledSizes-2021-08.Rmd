---
title: "Size Analysis, 2021-08-04"
output:
  html_notebook:
    code_folding: hide
---

# Tabs {.tabset}

## Load Data
```{r libs, message=FALSE, warning=FALSE}
# Check requisite packages are installed.
packages <- c(
  "dplyr",
  "RMTRCode2",
  "ggplot2",
  "tidyr",
  "BiodiversityR",
  "ggrepel"
)
for (pkg in packages) {
  library(pkg, character.only = TRUE)
}

# Reserved Names
communitiesAll <- NULL
invasionsDirected <- NULL
islandInteractionsOneEmptyTwo <- NULL
islandInteractionsOneEmptyTwoWhich <- NULL
islandInteractionsOneTwo <- NULL
islandInteractionsOneTwoWhich <- NULL
mats <- NULL
paramFrame <- NULL
plotScalingData <- NULL
pools <- NULL
```

```{r loadDat}
ellipsisApply <- function(..., FUN) {
  lapply(as.list(...), FUN)
}

load("LM1996-NumPoolCom-QOut-2021-05.RData")
# Stop if not all are not null
stopifnot(all(unlist(ellipsisApply(
  FUN = function(bool) {!is.null(bool)},
  communitiesAll,
  invasionsDirected,
  islandInteractionsOneEmptyTwo,
  islandInteractionsOneEmptyTwoWhich,
  islandInteractionsOneTwo,
  islandInteractionsOneTwoWhich,
  mats,
  paramFrame,
  plotScalingData,
  pools
))))
```

```{r retrieveSpecies}
sizeTypes <- NULL
for (row in 1:nrow(paramFrame)) {
  paramRow <- paramFrame[row, ]
  endStates <- names(paramRow$EndStates[[1]])[-(1:2)]
  if (length(endStates) < 1) next
  endSpecies <- lapply(endStates, RMTRCode2::CsvRowSplit)
  
  poolRow <- pools[[paramRow$DatasetID]][[paramRow$CombnNum]]
  
  endStates <- unlist(lapply(seq_along(endStates), function(i, st, sp) {
        rep(st[i], length(sp[[i]]))
      }, st = endStates, sp = endSpecies))
  
  endAbundancesRel <- unlist(lapply(paramRow$EndStateAbundance[[1]][-(1:2)], 
                                 function(s) {
                                   temp <- RMTRCode2::CsvRowSplit(s)
                                   temp / sum(temp)
                                   }))
  
  endAbundances <- unlist(lapply(paramRow$EndStateAbundance[[1]][-(1:2)], 
                                 RMTRCode2::CsvRowSplit))
  
  if (isTRUE(all.equal(NULL, endAbundances))) {
    # Might work better than is.null?
    endAbundances <- NA
  }
  if (isTRUE(all.equal(NULL, endAbundancesRel))) {
    # Might work better than is.null?
    endAbundancesRel <- NA
  }
  
  endSpecies <- unlist(endSpecies)
    
  sizeTypes <- rbind(
    sizeTypes,
    data.frame(
      ID = paste(paramRow$CombnNum, paramRow$DatasetID),
      Species = endSpecies, # Duplicates!
      State = endStates,
      Abundance = endAbundances,
      RelativeAbundance = endAbundancesRel,
      Size = poolRow$Size[endSpecies],
      Type = poolRow$Type[endSpecies],
      stringsAsFactors = FALSE
    ))
}

sizeTypes <- sizeTypes %>% dplyr::group_by(
  ID, Species, Size, Type
) %>% dplyr::summarise(
  States = list(State), 
  Abundances = list(Abundance),
  RelativeAbundances = list(RelativeAbundance),
  .groups = "drop"
) %>% dplyr::mutate(
  Source = "Simulation"
)
```

```{r genericPool}
genericPool <- RMTRCode2::LawMorton1996_species(1E4, 1E4, seed = 1)

combined <- rbind(
  sizeTypes %>% dplyr::mutate(
    ID = paste(ID, Species)
  ) %>% dplyr::select(
    -States, -Species, -Abundances, -RelativeAbundances, 
    ID, Type, Size, Source
  ),
  genericPool %>% dplyr::mutate(
    ID = as.character(ID),
    Source = "Generic, Seed 1"
  ) %>% dplyr::select(
    -ReproductionRate,
    ID, Type, Size, Source
  )
)

combined2 <- rbind(
  sizeTypes %>% dplyr::filter(
    lapply(States, length) > 1
  ) %>% dplyr::mutate(
    ID = paste(ID, Species)
  ) %>% dplyr::select(
    -States, -Species, -Abundances, -RelativeAbundances, 
    ID, Type, Size, Source
  ),
  genericPool %>% dplyr::mutate(
    ID = as.character(ID),
    Source = "Generic, Seed 1"
  ) %>% dplyr::select(
    -ReproductionRate,
    ID, Type, Size, Source
  )
)
```

## Sizes {.tabset}
### Raw Axis
```{r regSizes1}
ggplot2::ggplot(
  combined,
  ggplot2::aes(
    x = Size,
    fill = Type
  )
) + ggplot2::geom_histogram(
  bins = 100
) + ggplot2::facet_wrap(
  ~ Source, scales = "free_y", nrow = 2
)
```
### Log Axis
```{r logSizes1}
ggplot2::ggplot(
  combined,
  ggplot2::aes(
    x = log10(Size),
    fill = Type
  )
) + ggplot2::geom_histogram(
  bins = 100
) + ggplot2::facet_wrap(
  ~ Source, scales = "free_y", nrow = 2
)
```
## Amongst pools with at least 2 communities {.tabset}
### Raw Axis
```{r regSizes2}
ggplot2::ggplot(
  combined2,
  ggplot2::aes(
    x = Size,
    fill = Type
  )
) + ggplot2::geom_histogram(
  bins = 100
) + ggplot2::facet_wrap(
  ~ Source, scales = "free_y", nrow = 2
)
```
### Log Axis
```{r logSizes2}
ggplot2::ggplot(
  combined2,
  ggplot2::aes(
    x = log10(Size),
    fill = Type
  )
) + ggplot2::geom_histogram(
  bins = 100
) + ggplot2::facet_wrap(
  ~ Source, scales = "free_y", nrow = 2
)
```
## Largest Sizes {.tabset}
### Raw Axis
```{r regSizes3}
ggplot2::ggplot(
  sizeTypes %>% dplyr::group_by(
    ID, Type
  ) %>% dplyr::summarise(
    Size = max(Size), .groups = "drop"
  ),
  ggplot2::aes(
    x = Size,
    fill = Type
  )
) + ggplot2::geom_histogram(
  bins = 100
)
```
### Log Axis
```{r logSizes3}
ggplot2::ggplot(
  sizeTypes %>% dplyr::group_by(
    ID, Type
  ) %>% dplyr::summarise(
    Size = max(Size), .groups = "drop"
  ),
  ggplot2::aes(
    x = log10(Size),
    fill = Type
  )
) + ggplot2::geom_histogram(
  bins = 100
)
```

## Size Raw Abundance {.tabset}
### Overall
```{r sAoverall, warning=FALSE} 
ggplot2::ggplot(
  sizeTypes %>% dplyr::mutate(
    Abundance = unlist(lapply(Abundances, max, na.rm = TRUE))
  ) %>% dplyr::filter(
    Abundance > 0
  ) %>% dplyr::mutate(
    Rank = rank(-Abundance)
  ),
  ggplot2::aes(
    x = Size,
    y = Abundance,
    color = Type,
    linetype = Type
  )
) + ggplot2::geom_line(
) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```
### Dataset
```{r sAdataset, warning=FALSE} 
ggplot2::ggplot(
  sizeTypes %>% dplyr::mutate(
    Abundance = unlist(lapply(Abundances, max, na.rm = TRUE))
  ) %>% dplyr::filter(
    Abundance > 0
  ) %>% dplyr::group_by(
    ID
  ) %>% dplyr::mutate(
    Rank = rank(-Abundance)
  ),
  ggplot2::aes(
    x = Size,
    y = Abundance,
    color = Type,
    #linetype = Type,
    group = ID
  )
) + ggplot2::geom_line(
) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```
### Community
```{r sAcommunity, warning=FALSE} 
ggplot2::ggplot(
  tidyr::unnest(
    sizeTypes, cols = c("States", "Abundances")
  ) %>% dplyr::filter(
    !is.na(Abundances)
  ) %>% dplyr::group_by(
    ID, States
  ) %>% dplyr::mutate(
    Rank = rank(-Abundances)
  ),
  ggplot2::aes(
    x = Size,
    y = Abundances,
    color = Type,
    #linetype = Type,
    group = paste(ID, States)
  )
) + ggplot2::geom_line(
) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```

## Size Rel. Abundance {.tabset}
### Overall
```{r sRA, warning=FALSE} 
ggplot2::ggplot(
  sizeTypes %>% dplyr::mutate(
    RelativeAbundance = unlist(lapply(RelativeAbundances, max, na.rm = TRUE))
  ) %>% dplyr::filter(
    RelativeAbundance > 0
  ) %>% dplyr::mutate(
    Rank = rank(-RelativeAbundance)
  ),
  ggplot2::aes(
    x = Size,
    y = RelativeAbundance,
    color = Type,
    linetype = Type
  )
) + ggplot2::geom_line(
) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```
### Dataset
```{r sRAdataset, warning=FALSE} 
ggplot2::ggplot(
  sizeTypes %>% dplyr::mutate(
    RelativeAbundance = unlist(lapply(RelativeAbundances, max, na.rm = TRUE))
  ) %>% dplyr::filter(
    RelativeAbundance > 0
  ) %>% dplyr::group_by(
    ID
  ) %>% dplyr::mutate(
    Rank = rank(-RelativeAbundance)
  ),
  ggplot2::aes(
    x = Size,
    y = RelativeAbundance,
    color = Type,
    #linetype = Type,
    group = ID
  )
) + ggplot2::geom_line(
) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```

### Community
```{r sRAcommunity, warning=FALSE} 
ggplot2::ggplot(
  tidyr::unnest(
    sizeTypes, cols = c("States", "RelativeAbundances")
  ) %>% dplyr::filter(
    !is.na(RelativeAbundances)
  ) %>% dplyr::group_by(
    ID, States
  ) %>% dplyr::mutate(
    Rank = rank(-RelativeAbundances)
  ),
  ggplot2::aes(
    x = Size,
    y = RelativeAbundances,
    color = Type,
    #linetype = Type,
    group = paste(ID, States)
  )
) + ggplot2::geom_line(
) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```

## Rank Raw Abundance {.tabset}
### Overall
```{r rAoverall, warning=FALSE} 
ggplot2::ggplot(
  sizeTypes %>% dplyr::mutate(
    Abundance = unlist(lapply(Abundances, max, na.rm = TRUE))
  ) %>% dplyr::filter(
    Abundance > 0
  ) %>% dplyr::mutate(
    Rank = rank(-Abundance)
  ),
  ggplot2::aes(
    x = Rank,
    y = Abundance,
    color = Type,
    linetype = Type
  )
) + ggplot2::geom_line(
# ) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```
### Dataset
```{r rAdataset, warning=FALSE} 
ggplot2::ggplot(
  sizeTypes %>% dplyr::mutate(
    Abundance = unlist(lapply(Abundances, max, na.rm = TRUE))
  ) %>% dplyr::filter(
    Abundance > 0
  ) %>% dplyr::group_by(
    ID
  ) %>% dplyr::mutate(
    Rank = rank(-Abundance)
  ),
  ggplot2::aes(
    x = Rank,
    y = Abundance,
    color = Type,
    #linetype = Type,
    group = ID
  )
) + ggplot2::geom_line(
# ) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```
### Community
```{r rAcommunity, warning=FALSE} 
ggplot2::ggplot(
  tidyr::unnest(
    sizeTypes, cols = c("States", "Abundances")
  ) %>% dplyr::filter(
    !is.na(Abundances)
  ) %>% dplyr::group_by(
    ID, States
  ) %>% dplyr::mutate(
    Rank = rank(-Abundances)
  ),
  ggplot2::aes(
    x = Rank,
    y = Abundances,
    color = Type,
    #linetype = Type,
    group = paste(ID, States)
  )
) + ggplot2::geom_line(
# ) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```

## Rank Rel. Abundance {.tabset}
### Overall
```{r RrA, warning=FALSE} 
ggplot2::ggplot(
  sizeTypes %>% dplyr::mutate(
    RelativeAbundance = unlist(lapply(RelativeAbundances, max, na.rm = TRUE))
  ) %>% dplyr::filter(
    RelativeAbundance > 0
  ) %>% dplyr::mutate(
    Rank = rank(-RelativeAbundance)
  ),
  ggplot2::aes(
    x = Rank,
    y = RelativeAbundance,
    color = Type,
    linetype = Type
  )
) + ggplot2::geom_line(
# ) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```
### Dataset
```{r RrAdataset, warning=FALSE} 
ggplot2::ggplot(
  sizeTypes %>% dplyr::mutate(
    RelativeAbundance = unlist(lapply(RelativeAbundances, max, na.rm = TRUE))
  ) %>% dplyr::filter(
    RelativeAbundance > 0
  ) %>% dplyr::group_by(
    ID
  ) %>% dplyr::mutate(
    Rank = rank(-RelativeAbundance)
  ),
  ggplot2::aes(
    x = Rank,
    y = RelativeAbundance,
    color = Type,
    #linetype = Type,
    group = ID
  )
) + ggplot2::geom_line(
# ) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```

### Community
```{r RrAcommunity, warning=FALSE} 
ggplot2::ggplot(
  tidyr::unnest(
    sizeTypes, cols = c("States", "RelativeAbundances")
  ) %>% dplyr::filter(
    !is.na(RelativeAbundances)
  ) %>% dplyr::group_by(
    ID, States
  ) %>% dplyr::mutate(
    Rank = rank(-RelativeAbundances)
  ),
  ggplot2::aes(
    x = Rank,
    y = RelativeAbundances,
    color = Type,
    #linetype = Type,
    group = paste(ID, States)
  )
) + ggplot2::geom_line(
# ) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```
## BiodiversityR Approach {.tabset}

## Rel. Rank Raw Abundance {.tabset}
### Overall
```{r rRAoverall, warning=FALSE} 
ggplot2::ggplot(
  sizeTypes %>% dplyr::mutate(
    Abundance = unlist(lapply(Abundances, max, na.rm = TRUE))
  ) %>% dplyr::filter(
    Abundance > 0
  ) %>% dplyr::mutate(
    Rank = rank(-Abundance),
    RelativeRank = (Rank - 1) / (max(Rank) - 1)
  ),
  ggplot2::aes(
    x = RelativeRank,
    y = Abundance,
    color = Type,
    linetype = Type
  )
) + ggplot2::geom_line(
# ) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```
### Dataset
```{r rRAdataset, warning=FALSE} 
ggplot2::ggplot(
  sizeTypes %>% dplyr::mutate(
    Abundance = unlist(lapply(Abundances, max, na.rm = TRUE))
  ) %>% dplyr::filter(
    Abundance > 0
  ) %>% dplyr::group_by(
    ID
  ) %>% dplyr::mutate(
    Rank = rank(-Abundance),
    RelativeRank = (Rank - 1) / (max(Rank) - 1)
  ),
  ggplot2::aes(
    x = RelativeRank,
    y = Abundance,
    color = Type,
    #linetype = Type,
    group = ID
  )
) + ggplot2::geom_line(
# ) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```
### Community
```{r rRAcommunity, warning=FALSE} 
ggplot2::ggplot(
  tidyr::unnest(
    sizeTypes, cols = c("States", "Abundances")
  ) %>% dplyr::filter(
    !is.na(Abundances)
  ) %>% dplyr::group_by(
    ID, States
  ) %>% dplyr::mutate(
    Rank = rank(-Abundances),
    RelativeRank = (Rank - 1) / (max(Rank) - 1)
  ),
  ggplot2::aes(
    x = RelativeRank,
    y = Abundances,
    color = Type,
    #linetype = Type,
    group = paste(ID, States)
  )
) + ggplot2::geom_line(
# ) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```

## Rel. Rank Rel. Abundance {.tabset}
### Overall
```{r rRrA, warning=FALSE} 
ggplot2::ggplot(
  sizeTypes %>% dplyr::mutate(
    RelativeAbundance = unlist(lapply(RelativeAbundances, max, na.rm = TRUE))
  ) %>% dplyr::filter(
    RelativeAbundance > 0
  ) %>% dplyr::mutate(
    Rank = rank(-RelativeAbundance),
    RelativeRank = (Rank - 1) / (max(Rank) - 1)
  ),
  ggplot2::aes(
    x = RelativeRank,
    y = RelativeAbundance,
    color = Type,
    linetype = Type
  )
) + ggplot2::geom_line(
# ) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```
### Dataset
```{r rRrAdataset, warning=FALSE} 
ggplot2::ggplot(
  sizeTypes %>% dplyr::mutate(
    RelativeAbundance = unlist(lapply(RelativeAbundances, max, na.rm = TRUE))
  ) %>% dplyr::filter(
    RelativeAbundance > 0
  ) %>% dplyr::group_by(
    ID
  ) %>% dplyr::mutate(
    Rank = rank(-RelativeAbundance),
    RelativeRank = (Rank - 1) / (max(Rank) - 1)
  ),
  ggplot2::aes(
    x = RelativeRank,
    y = RelativeAbundance,
    color = Type,
    #linetype = Type,
    group = ID
  )
) + ggplot2::geom_line(
# ) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```

### Community
```{r rRrAcommunity, warning=FALSE} 
ggplot2::ggplot(
  tidyr::unnest(
    sizeTypes, cols = c("States", "RelativeAbundances")
  ) %>% dplyr::filter(
    !is.na(RelativeAbundances)
  ) %>% dplyr::group_by(
    ID, States
  ) %>% dplyr::mutate(
    Rank = rank(-RelativeAbundances),
    RelativeRank = (Rank - 1) / (max(Rank) - 1)
  ),
  ggplot2::aes(
    x = RelativeRank,
    y = RelativeAbundances,
    color = Type,
    #linetype = Type,
    group = paste(ID, States)
  )
) + ggplot2::geom_line(
# ) + ggplot2::scale_x_log10(
) + ggplot2::scale_y_log10(
)
```

## BiodiversityR Approach {.tabset}

### Overall
```{r BiodiversityR, warning=FALSE}
# Reformat: 
# Community data frame with sites as rows, species as columns and species abundance as cell values.
bdR <- tidyr::unnest(
    sizeTypes, cols = c("States", "Abundances")
) %>% dplyr::filter(
    !is.na(Abundances)
) %>% dplyr::mutate(
    Species = paste(ID, Species),
    Site = paste(ID, States, sep = ": ")
) %>% dplyr::select(
  -ID, -Size, -Type, -States, -RelativeAbundances, -Source
) %>% tidyr::pivot_wider(
  names_from = Species,
  values_from = Abundances,
  values_fill = 0
)

bdRrankabundance <- BiodiversityR::rankabundance(as.data.frame(bdR[, -1]))

# BiodiversityR::rankabunplot(bdRrankabundance, scale = "logabun")

# From documentation
ggplot(
  data=as.data.frame(bdRrankabundance), 
  aes(x = rank, y = abundance)) + 
    scale_x_continuous(expand=c(0, 1), sec.axis = dup_axis(labels=NULL, name=NULL)) +
    scale_y_log10(expand=c(0, 1), sec.axis = dup_axis(labels=NULL, name=NULL)) +
    geom_line(size=1) +
    geom_point(size=5, alpha=0.7) +
    labs(x = "rank", y = "abundance")
```
